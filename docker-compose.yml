services:
  # ============================================
  # BAZY DANYCH (MySQL)
  # ============================================

  mysql-album:
    image: mysql:8.0
    container_name: mysql-album
    ports:
      - "3307:3306"
    environment:
      - MYSQL_ROOT_PASSWORD=root_password
      - MYSQL_DATABASE=album_db
      - MYSQL_USER=album_user
      - MYSQL_PASSWORD=album_password
    volumes:
      - mysql-album-data:/var/lib/mysql
    networks:
      - music-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 5s
      timeout: 20s
      retries: 10

  mysql-song:
    image: mysql:8.0
    container_name: mysql-song
    ports:
      - "3308:3306"
    environment:
      - MYSQL_ROOT_PASSWORD=root_password
      - MYSQL_DATABASE=song_db
      - MYSQL_USER=song_user
      - MYSQL_PASSWORD=song_password
    volumes:
      - mysql-song-data:/var/lib/mysql
    networks:
      - music-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 5s
      timeout: 20s
      retries: 10

  # ============================================
  # SERVICE DISCOVERY (Eureka)
  # ============================================

  eureka-service:
    build:
      context: ./eureka-service
      dockerfile: Dockerfile
    container_name: eureka-service
    ports:
      - "8761:8761"
    networks:
      - music-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8761/actuator/health"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 40s

  # ============================================
  # MIKROUSŁUGI (Spring Boot)
  # ============================================

  # Pierwsza instancja serwisu piosenek
  song-service-1:
    build:
      context: ./song-service
      dockerfile: Dockerfile
    environment:
      - SERVER_PORT=8082
      - SPRING_APPLICATION_NAME=song-service
      - EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE=http://eureka-service:8761/eureka/
      - SPRING_DATASOURCE_URL=jdbc:mysql://mysql-song:3306/song_db
      - SPRING_DATASOURCE_USERNAME=song_user
      - SPRING_DATASOURCE_PASSWORD=song_password
    depends_on:
      mysql-song:
        condition: service_healthy
      eureka-service:
        condition: service_healthy
    networks:
      - music-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8082/actuator/health"]
      interval: 10s
      timeout: 10s
      retries: 15
      start_period: 90s

  # Druga instancja serwisu piosenek (Lab 7 - Load Balancing)
  song-service-2:
    build:
      context: ./song-service
      dockerfile: Dockerfile
    environment:
      - SERVER_PORT=8082
      - SPRING_APPLICATION_NAME=song-service
      - EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE=http://eureka-service:8761/eureka/
      - SPRING_DATASOURCE_URL=jdbc:mysql://mysql-song:3306/song_db
      - SPRING_DATASOURCE_USERNAME=song_user
      - SPRING_DATASOURCE_PASSWORD=song_password
    depends_on:
      mysql-song:
        condition: service_healthy
      eureka-service:
        condition: service_healthy
    networks:
      - music-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8082/actuator/health"]
      interval: 10s
      timeout: 10s
      retries: 15
      start_period: 90s

  # Serwis albumów
  album-service:
    build:
      context: ./album-service
      dockerfile: Dockerfile
    environment:
      - SERVER_PORT=8081
      - SPRING_APPLICATION_NAME=album-service
      - EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE=http://eureka-service:8761/eureka/
      - SPRING_DATASOURCE_URL=jdbc:mysql://mysql-album:3306/album_db
      - SPRING_DATASOURCE_USERNAME=album_user
      - SPRING_DATASOURCE_PASSWORD=album_password
      - SONG_SERVICE_URL=http://song-service
    depends_on:
      mysql-album:
        condition: service_healthy
      eureka-service:
        condition: service_healthy
    networks:
      - music-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8081/actuator/health"]
      interval: 10s
      timeout: 10s
      retries: 15
      start_period: 90s

  # Bramka API (Gateway)
  gateway-service:
    build:
      context: ./gateway-service
      dockerfile: Dockerfile
    container_name: gateway-service
    ports:
      - "8080:8080"
    environment:
      - SERVER_PORT=8080
      - SPRING_APPLICATION_NAME=gateway-service
      - EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE=http://eureka-service:8761/eureka/
    depends_on:
      eureka-service:
        condition: service_healthy
    networks:
      - music-network

  # ============================================
  # FRONTEND (Angular + NGINX)
  # ============================================

  angular-app:
    build:
      context: ./music-management
      dockerfile: Dockerfile
    container_name: angular-app
    ports:
      - "3000:80"
    environment:
      - NGINX_HOST=localhost
      - NGINX_PORT=80
    depends_on:
      gateway-service:
        condition: service_started
    networks:
      - music-network

# ============================================
# KONFIGURACJA SIECI I WOLUMENÓW
# ============================================

networks:
  music-network:
    driver: bridge

volumes:
  mysql-album-data:
  mysql-song-data: